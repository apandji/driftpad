<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- ADD YOUR SOCIAL META TAGS HERE -->
    <meta property="og:title" content="Driftpad. Draw on driftpad, and
    find your inner peace.">
    <meta property="og:description" content="A meditative digital drawing experience">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://driftpad.app">
    <meta name="twitter:title" content="Driftpad. Meditative digital drawing experience">
    <meta name="twitter:description" content="A meditative digital drawing experience inspired by sumi ink painting">
    <title>driftpad</title>
    <link rel="stylesheet" href="style.css?v=14">
        <!-- Umami Analytics -->
        <script defer src="https://cloud.umami.is/script.js" data-website-id="8ae5578c-320f-4d25-860a-f93ed10e541e"></script>
</head>
<body>
    <header>
        <div class="header-left">
            <logo class="logo" id="logo">driftpad</logo>
            <div id="streak-indicator" class="streak-indicator">üåä 0</div>
        </div>
        <div class="header-right">
            <button id="feedback-btn">feedback</button>
            <button id="gallery-btn">gallery</button>
        </div>
    </header>
    <div class="prompt-container">
        <div class="mode-controls">
            <div class="mode-selector-row">
                <h2 class="prompt" style="font-size: 20px;">text</h2>
            </div>
        </div>
    </div>
    <section id="sketch" class="section">
        <div class="container sketch">
            <div class="canvas-wrap">
                <canvas id="canvas" aria-label="drawing canvas"></canvas>
                <div id="cursor" class="brush-cursor"></div>
            </div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onload="console.log('‚úÖ Supabase library loaded')" onerror="console.error('‚ùå Failed to load Supabase library')"></script>
    <script src="js/watercolor-brush.js?v=2" defer></script>
    <script src="js/fade-timer.js" defer></script>
    <script src="js/shape-generator.js"></script>
    <script src="js/prompts-v2.js?v=33" defer></script>
    <script src="js/sketch.js?v=5" defer></script>
    <script src="js/pull-to-refresh.js" defer></script>
    <script src="js/feedback-collector.js" defer></script>
    <script src="js/local-streak.js" defer></script>
    
    <!-- Simple Feedback Modal -->
    <div id="feedback-modal" class="feedback-modal" style="display: none;">
        <div class="feedback-content">
            <h2>What do you think of driftpad?</h2>
            <form id="feedback-form" action="https://formspree.io/f/xdkwgkbd" method="POST">
                <div class="feedback-type">
                    <label>
                        <input type="radio" name="feedback_type" value="bug" required>
                        üêõ Bug report
                    </label>
                    <label>
                        <input type="radio" name="feedback_type" value="feature" required>
                        üí° Feature request
                    </label>
                    <label>
                        <input type="radio" name="feedback_type" value="general" required>
                        üí¨ General feedback
                    </label>
                </div>
                <textarea name="message" placeholder="Tell us what's on your mind..." required></textarea>
                <input type="email" name="email" placeholder="Your email (optional)">
                <div class="feedback-actions">
                    <button type="button" id="close-feedback">Cancel</button>
                    <button type="submit">Send feedback</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Simple feedback modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            const feedbackBtn = document.getElementById('feedback-btn');
            const feedbackModal = document.getElementById('feedback-modal');
            const closeBtn = document.getElementById('close-feedback');
            const feedbackForm = document.getElementById('feedback-form');
            
            // Open modal
            feedbackBtn.addEventListener('click', function() {
                feedbackModal.style.display = 'flex';
            });
            
            // Close modal
            closeBtn.addEventListener('click', function() {
                feedbackModal.style.display = 'none';
            });
            
            // Close modal when clicking outside
            feedbackModal.addEventListener('click', function(e) {
                if (e.target === feedbackModal) {
                    feedbackModal.style.display = 'none';
                }
            });
            
            // Make openFeedbackModal globally accessible
            window.openFeedbackModal = function() {
                feedbackModal.style.display = 'flex';
            };
            
            // Test: Add click handler for feedback button in onboarding modal
            setTimeout(() => {
                const onboardingFeedbackBtn = document.getElementById('feedback-button');
                if (onboardingFeedbackBtn) {
                    console.log('Found onboarding feedback button, adding click handler');
                    onboardingFeedbackBtn.addEventListener('click', function(e) {
                        console.log('Onboarding feedback button clicked!');
                        e.preventDefault();
                        // Close onboarding modal
                        const onboardingModal = document.getElementById('onboarding-modal');
                        if (onboardingModal) {
                            onboardingModal.style.display = 'none';
                            localStorage.setItem('driftpad-onboarding-seen', 'true');
                        }
                        // Open feedback modal
                        feedbackModal.style.display = 'flex';
                    });
                } else {
                    console.log('Onboarding feedback button not found');
                }
            }, 1000);
            
            // Handle form submission
            feedbackForm.addEventListener('submit', function(e) {
                // Don't prevent default - let the form submit to Formspree
                // e.preventDefault();
                
                // Debug: Log form data
                const formData = new FormData(feedbackForm);
                console.log('Form data:', Object.fromEntries(formData));
                
                // Show success message after a short delay
                setTimeout(() => {
                    alert('Thank you for your feedback! We\'ll get back to you soon.');
                    
                    // Close modal
                    feedbackModal.style.display = 'none';
                    
                    // Reset form
                    feedbackForm.reset();
                }, 100);
            });
        });
        
        // Supabase configuration (for drawings)
        (function() {
            'use strict';
            
            const SUPABASE_URL = 'https://rwdllkszmgallbrqbqkk.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3ZGxsa3N6bWdhbGxicnFicWtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MjQ1MjYsImV4cCI6MjA3NDUwMDUyNn0.-hGEPB0F7SLL6rd9MHvyoTGsGMqrJDPyIOv5amdld0s';
            
            // Initialize Supabase client and make it globally available
            // Wait for Supabase library to load before initializing
            let supabaseInitAttempts = 0;
            const maxSupabaseInitAttempts = 50; // 5 seconds max (50 * 100ms)
            
            function initSupabaseClient() {
                supabaseInitAttempts++;
                
                // Access supabase via window to avoid variable shadowing
                const supabaseLib = window.supabase;
                
                if (typeof supabaseLib !== 'undefined' && supabaseLib && supabaseLib.createClient) {
                    try {
                        window.supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('‚úÖ Supabase client initialized successfully');
                        // Dispatch event to notify other scripts
                        window.dispatchEvent(new CustomEvent('supabaseReady'));
                    } catch (error) {
                        console.error('‚ùå Error initializing Supabase client:', error);
                        window.supabaseClient = null;
                        // Dispatch event anyway so scripts know Supabase failed
                        window.dispatchEvent(new CustomEvent('supabaseReady', { detail: { error: error } }));
                    }
                } else if (supabaseInitAttempts < maxSupabaseInitAttempts) {
                    // Retry after a short delay if Supabase library isn't loaded yet
                    if (supabaseInitAttempts % 10 === 0) {
                        console.log('‚è≥ Waiting for Supabase library to load... (attempt', supabaseInitAttempts + ')');
                    }
                    setTimeout(initSupabaseClient, 100);
                } else {
                    console.error('‚ùå Supabase library failed to load after', maxSupabaseInitAttempts, 'attempts');
                    window.supabaseClient = null;
                    // Dispatch event to notify scripts that Supabase is not available
                    window.dispatchEvent(new CustomEvent('supabaseReady', { detail: { error: 'Library load timeout' } }));
                }
            }
            
            // Start initialization when DOM is ready or immediately if already ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSupabaseClient);
            } else {
                initSupabaseClient();
            }
        })();
        
        
        // Generate or get user UUID (for drawings)
        function getUserUUID() {
            let userUUID = localStorage.getItem('user_uuid');
            if (!userUUID) {
                userUUID = crypto.randomUUID();
                localStorage.setItem('user_uuid', userUUID);
            }
            return userUUID;
        }
        
        // Cursor tracking for toast positioning
        let cursorX = window.innerWidth / 2;
        let cursorY = window.innerHeight / 2;
        
        // Track cursor movement
        document.addEventListener('mousemove', (e) => {
            cursorX = e.clientX;
            cursorY = e.clientY;
        });
        
        // Show zen-like toast notification with floating animation
        window.showToast = function(message) {
            // Remove any existing toasts
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Apply cursor-responsive positioning
            const updateToastPosition = () => {
                const centerX = window.innerWidth / 2;
                const centerY = 20; // Base position from top
                
                // Calculate offset based on cursor position
                const cursorOffsetX = (cursorX - centerX) * 0.1; // Subtle influence
                const cursorOffsetY = Math.max(0, (cursorY - centerY) * 0.05); // Gentle vertical drift
                
                // Apply the offset with smooth animation
                const finalX = centerX + cursorOffsetX;
                const finalY = centerY + cursorOffsetY;
                
                toast.style.left = finalX + 'px';
                toast.style.top = finalY + 'px';
                toast.style.transform = `translateX(-50%) translateY(${Math.sin(Date.now() * 0.002) * 2}px) rotate(${Math.sin(Date.now() * 0.001) * 0.5}deg)`;
                
                // Update shadow based on cursor proximity
                const distance = Math.sqrt(Math.pow(cursorX - finalX, 2) + Math.pow(cursorY - finalY, 2));
                const shadowIntensity = Math.max(0.1, 0.3 - (distance / 1000));
                toast.style.boxShadow = `0 4px 20px rgba(0, 0, 0, ${shadowIntensity}), 0 0 ${Math.sin(Date.now() * 0.003) * 10 + 15}px rgba(0, 0, 0, 0.1)`;
            };
            
            // Update position continuously while toast is visible
            const positionInterval = setInterval(updateToastPosition, 50);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                clearInterval(positionInterval);
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 600);
            }, 3000);
        }
        
        // Slow dissolve animation for canvas
        window.dissolveCanvas = function() {
            const canvas = document.getElementById('canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const originalComposite = ctx.globalCompositeOperation;
                
                // Create a smooth fade-to-gradient effect that matches canvas background
                let opacity = 1;
                const fadeInterval = setInterval(() => {
                    opacity -= 0.02; // Fade out over 2 seconds
                    
                    if (opacity <= 0) {
                        clearInterval(fadeInterval);
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.globalCompositeOperation = originalComposite;
                    } else {
                        // Create a gradient overlay that matches the canvas background
                        ctx.globalCompositeOperation = 'source-over';
                        
                        // Create gradient from #d2d2d2 to #f3f3f3 (matching canvas background)
                        const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
                        gradient.addColorStop(0, `rgba(210, 210, 210, ${1 - opacity})`); // #d2d2d2
                        gradient.addColorStop(1, `rgba(243, 243, 243, ${1 - opacity})`); // #f3f3f3
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                }, 40); // ~25fps for smooth animation
            }
        }
        
        // Submit drawing to gallery
        window.submitDrawing = async function() {
            const canvas = document.getElementById('canvas');
            const prompt = document.querySelector('.prompt').textContent;
            
            if (!canvas) {
                alert('No canvas found');
                return;
            }
            
            // Check if canvas has any content
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasContent = imageData.data.some(pixel => pixel !== 0);
            
            if (!hasContent) {
                window.showToast('Please draw something before submitting');
                return;
            }
            
            try {
                const imageData = canvas.toDataURL('image/png');
                const userUUID = getUserUUID();
                
                if (!window.supabaseClient) {
                    window.showToast('Database not ready. Please try again.');
                    return;
                }
                
                const { data, error } = await window.supabaseClient
                    .from('drawings')
                    .insert({
                        user_uuid: userUUID,
                        image_data: imageData,
                        prompt: prompt,
                        is_public: true
                    });
                
                if (error) {
                    console.error('Error submitting drawing:', error);
                    window.showToast('Failed to submit drawing. Please try again.');
                } else {
                    window.showToast('Drawing submitted to gallery');
                    
                    // Track drawing submission with feedback collector
                    if (window.feedbackCollector && data && data[0]) {
                        window.feedbackCollector.trackDrawingSubmitted(data[0].id);
                    }
                    
                    // Slow dissolve animation before clearing
                    window.dissolveCanvas();
                    setTimeout(() => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }, 2000);
                }
            } catch (err) {
                console.error('Error:', err);
                window.showToast('Failed to submit drawing. Please try again.');
            }
        };
        
        // Add submit button event listener
        document.addEventListener('DOMContentLoaded', function() {
            const submitBtn = document.getElementById('submit');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitDrawing);
            }
            
            // Make entire gallery button tappable
            const galleryBtn = document.getElementById('gallery-btn');
            if (galleryBtn) {
                galleryBtn.addEventListener('click', function() {
                    window.location.href = 'gallery.html';
                });
            }
            
            // Update streak on page visit
            if (window.localStreakManager) {
                window.localStreakManager.updateStreak();
            }
            
        });
        
    </script>
    
    <!-- Loading indicator for toolbar -->
    <div class="toolbar-loading" id="toolbar-loading">
        <div class="toolbar-loading-spinner"></div>
        <span>Loading colors...</span>
    </div>
    
     <div class="toolbar" role="toolbar" aria-label="drawing controls">
        <div class="color-palette-bar">
            <div id="zen-colors" class="zen-color-palette"></div>
            <div class="eraser-swatch" id="eraser-swatch" title="Eraser">
                üßπ
            </div>
        </div>
        <div class="action-buttons">
            <button id="new-prompt-btn" type="button">refresh</button>
            <button id="clear" type="button">clear</button>
            <button id="submit" type="button">submit</button>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="onboarding-modal" style="display: none;">
        <div class="onboarding-content" style="animation: fadeIn 0.6s ease-out, modalFloat 3s ease-in-out infinite;">
            <p>Draw on driftpad, and <br>find your inner peace.</p>
            <p>Respond to a prompt, complete a picture or freely doodle.</p>
            <p>No timelines, no deadlines.<br>Let your mind drift.</p>
            <button id="onboarding-close" class="onboarding-close">Begin</button>
            <hr class="modal-divider">
            <p class="support-text">If driftpad brings you joy, consider supporting its journey and keeping this space peaceful and free.</p>
            <div class="modal-buttons">
                <a href="https://www.buymeacoffee.com/pandjico" target="_blank" rel="noopener noreferrer" class="coffee-button-modal">
                    <span>‚òï</span> Support
                </a>
                <button id="feedback-button" class="feedback-button-modal">
                    üí¨ Feedback
                </button>
            </div>
            <p class="caption">Made with ‚ù§Ô∏è in St. Louis by @pandjico</p>
        </div>
    </div>
</body>
<footer>
</footer>
</html>